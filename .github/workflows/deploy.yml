name: Deploy to Fly.io
on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

    steps:
    # 0. check-out code
    - uses: actions/checkout@v4

    # 1. speed up Cargo outside Docker ?
    - name: Cache Cargo registry & git
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
        key: cargo-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          cargo-${{ runner.os }}-

    # 2. set up Fly CLI
    - uses: superfly/flyctl-actions/setup-flyctl@v1

    # 3. authenticate docker client to Fly registry
    - name: Login to Fly registry
      run: flyctl auth docker # just a thin wrapper for `docker login`
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }} # needed here too

    # 4. enable Buildx
    - uses: docker/setup-buildx-action@v3
      with:
        install: true # puts `docker buildx` on PATH
        driver-opts: |
            image=moby/buildkit:latest

    # 5. build AND push, using GHA cache
    - name: Build & push image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: registry.fly.io/yus:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
            BUILDKIT_INLINE_CACHE=1

    # 6. set/update any secrets after the build
    - name: Update PAT if changed
      run: flyctl secrets set PROJECTS_PAT="${{ secrets.PROJECTS_PAT }}" -a yus

    # 7. deploy the image
    - name: Deploy image
      run: flyctl deploy --image registry.fly.io/yus:${{ github.sha }} -a yus

